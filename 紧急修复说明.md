# 🚨 紧急修复说明

## 您遇到的错误

```
ValueError: Cannot find atomic coordinate info.
```

## 🔧 快速修复方案

### 方案1: 一键修复并训练（最简单）⭐

```bash
# 1. 拉取最新代码
git pull origin claude/alignn-binary-classification-01Gd3smtc3KBu4WsA7u8tEUy

# 2. 运行一键脚本
chmod +x 一键修复并训练.sh fix_data_format.py
./一键修复并训练.sh
```

这个脚本会：
- ✅ 自动检测数据位置
- ✅ 自动修复 id_prop.csv 格式
- ✅ 检查 CIF 文件可读性
- ✅ 移除无法读取的文件
- ✅ 开始训练

### 方案2: 手动修复

```bash
# 1. 修复数据格式
python fix_data_format.py ./data/cif

# 2. 根据提示操作（可能需要移除无法读取的CIF文件）

# 3. 开始训练
train_alignn.py \
    --root_dir ./data/cif \
    --config config_large_dataset.json \
    --classification_threshold 0.5 \
    --batch_size 128 \
    --epochs 100 \
    --output_dir ./results
```

## 📋 问题原因

### 问题1: id_prop.csv 格式错误

**您当前的格式：**
```csv
0.cif,1
1.cif,1
2.cif,1
```

**正确格式：**
```csv
id,target
0,1
1,0
2,1
```

**fix_data_format.py 会自动修复：**
- ✅ 添加 header（id, target）
- ✅ 移除 .cif 后缀
- ✅ 备份原文件

### 问题2: 部分CIF文件无法读取

某些CIF文件可能：
- 缺少原子坐标信息
- 格式不完整
- 数据损坏

**fix_data_format.py 会：**
- ✅ 测试读取前10个CIF文件
- ✅ 显示无法读取的文件
- ✅ 询问是否移除这些文件

### 问题3: cif2cell 未安装（可选）

如果看到警告：`sh: cif2cell: command not found`

**不影响训练，但如果需要安装：**
```bash
conda install -c conda-forge cif2cell
```

## 🎯 推荐修复流程

```bash
# 第1步：拉取最新修复工具
cd /path/to/alignn
git pull origin claude/alignn-binary-classification-01Gd3smtc3KBu4WsA7u8tEUy

# 第2步：给脚本执行权限
chmod +x 一键修复并训练.sh fix_data_format.py

# 第3步：运行一键修复
./一键修复并训练.sh

# 完成！
```

## 🔍 如果还有问题

### 检查数据目录结构

```bash
# 查看目录结构
ls -la ./data/
ls -la ./data/cif/

# 查看 id_prop.csv
head -10 ./data/id_prop.csv
# 或
head -10 ./data/cif/id_prop.csv

# 统计CIF文件
find ./data -name "*.cif" | wc -l
```

### 手动测试CIF文件

```python
from jarvis.core.atoms import Atoms

# 测试单个文件
atoms = Atoms.from_cif('./data/cif/0.cif')
print(atoms)
```

如果出错，说明该CIF文件格式有问题。

### 分批处理

如果有大量无法读取的文件：

```bash
# 1. 先修复格式
python fix_data_format.py ./data/cif

# 2. 当询问是否移除无法读取的文件时，选择 'y'

# 3. 再次运行检查
python fix_data_format.py ./data/cif

# 4. 直到所有文件都可读
```

## 📊 预期结果

修复成功后，您应该看到：

```
=====================================================
ALIGNN 数据格式自动修复工具
=====================================================

数据目录: ./data/cif

=====================================================
修复 id_prop.csv
=====================================================
✓ 已备份到: ./data/cif/id_prop.csv.backup
✓ 已修复 id_prop.csv
  总行数: 108134

修复后的前5行:
       id  target
0       0       1
1       1       1
2       2       1
3       3       1
4       4       1

=====================================================
检查 CIF 文件
=====================================================

找到 108134 个 CIF 文件

✓ 所有ID都有对应的CIF文件

测试读取CIF文件...
  可读取: 10/10
  ✓ 所有测试文件都可以正常读取

=====================================================
数据统计
=====================================================
总样本数: 108134

目标值统计:
count    108134.000000
mean          0.xxx
std           0.xxx
min           0.xxx
25%           0.xxx
50%           0.xxx
75%           0.xxx
max           1.xxx

分类阈值建议:
...

=====================================================
✅ 数据修复完成！
=====================================================

现在可以开始训练:
  ./一键修复并训练.sh
```

## 🚀 修复后开始训练

```bash
# 如果已经运行了一键修复脚本，训练会自动开始

# 或者手动运行
train_alignn.py \
    --root_dir ./data/cif \
    --config config_large_dataset.json \
    --classification_threshold 0.5 \
    --batch_size 128 \
    --epochs 100 \
    --output_dir ./results_108k
```

## 💡 关键提示

1. **一定要修复 id_prop.csv**：必须有 header，ID 不能有 .cif 后缀
2. **检查 CIF 文件**：确保至少大部分文件可以正常读取
3. **使用一键脚本**：自动处理所有问题，最省心

## 📞 需要帮助？

如果问题仍未解决：

```bash
# 运行完整诊断
python fix_data_format.py ./data/cif 2>&1 | tee diagnosis.log

# 查看诊断日志
cat diagnosis.log
```

然后提供 diagnosis.log 内容进行进一步排查。

---

**立即修复：**
```bash
chmod +x 一键修复并训练.sh fix_data_format.py
./一键修复并训练.sh
```
