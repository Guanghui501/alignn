# ALIGNN 配置文件参数说明

## 模型配置参数详解

### ALIGNN 模型 (name: "alignn")

这是标准的 ALIGNN 模型，用于图级别的预测任务（如分类、回归）。

#### 支持的参数

```json
{
  "name": "alignn",
  "alignn_layers": 4,              // ALIGNN层数，默认4
  "gcn_layers": 4,                 // GCN层数，默认4
  "atom_input_features": 92,       // 原子输入特征维度（cgcnn特征集为92）
  "edge_input_features": 80,       // 边输入特征维度
  "triplet_input_features": 40,    // 三元组特征维度
  "embedding_features": 64,        // 嵌入特征维度
  "hidden_features": 256,          // 隐藏层特征维度
  "output_features": 2,            // 输出特征维度（二分类为2）
  "link": "identity",              // 输出链接函数: identity/log/logit
  "zero_inflated": false,          // 是否使用零膨胀模型
  "classification": true,          // 是否为分类任务
  "num_classes": 2,                // 分类类别数（二分类为2）
  "extra_features": 0              // 额外特征维度
}
```

#### ❌ 不支持的参数
- `num_heads` - 此参数不存在于 ALIGNN 模型中
- `attention_heads` - 此参数不存在于 ALIGNN 模型中

### ALIGNN AtomWise 模型 (name: "alignn_atomwise")

用于原子级别的预测任务（如力场训练）。

```json
{
  "name": "alignn_atomwise",
  "alignn_layers": 4,
  "gcn_layers": 4,
  // ... 其他参数类似
  "output_features": 1,            // 原子级别输出
  "atomwise_output_features": 3,   // 原子级别输出特征（如力的3个分量）
  "calculate_gradient": true,      // 是否计算梯度（用于力场）
  "gradwise_weight": 1.0,          // 梯度损失权重
  "stresswise_weight": 0.0         // 应力损失权重
}
```

## 训练配置参数详解

### 基本设置

```json
{
  "dataset": "user_data",          // 数据集类型
  "target": "target",              // 目标列名
  "id_tag": "id",                  // ID列名
  "random_seed": 123,              // 随机种子
  "dtype": "float32"               // 数据类型
}
```

### 数据划分

```json
{
  "train_ratio": 0.8,              // 训练集比例
  "val_ratio": 0.1,                // 验证集比例
  "test_ratio": 0.1,               // 测试集比例

  // 或者使用固定数量
  "n_train": 1000,                 // 训练样本数
  "n_val": 100,                    // 验证样本数
  "n_test": 100                    // 测试样本数
}
```

### 分类设置

```json
{
  "classification_threshold": 0.5,  // 分类阈值
                                    // target > threshold -> 类别1
                                    // target <= threshold -> 类别0
  "model": {
    "classification": true,         // 启用分类模式
    "num_classes": 2,              // 类别数
    "output_features": 2           // 输出特征数（等于类别数）
  }
}
```

### 训练参数

```json
{
  "epochs": 300,                   // 训练轮数
  "batch_size": 32,                // 批次大小（根据GPU内存调整）
  "learning_rate": 0.001,          // 学习率
  "weight_decay": 0,               // 权重衰减
  "optimizer": "adamw",            // 优化器: adamw/sgd
  "scheduler": "onecycle",         // 学习率调度器: onecycle/none/step
  "criterion": "mse"               // 损失函数: mse/l1/poisson
}
```

### 图构建参数

```json
{
  "atom_features": "cgcnn",        // 原子特征: cgcnn/basic/atomic_number/cfid
  "neighbor_strategy": "k-nearest", // 邻居策略: k-nearest/voronoi/radius_graph
  "cutoff": 8.0,                   // 截断半径（Å）
  "max_neighbors": 12,             // 最大邻居数
  "compute_line_graph": true       // 是否计算线图（三体相互作用）
}
```

### 性能优化

```json
{
  "num_workers": 4,                // 数据加载线程数
  "pin_memory": false,             // 是否固定内存
  "use_lmdb": true,                // 是否使用LMDB缓存
  "save_dataloader": false         // 是否保存数据加载器
}
```

### 输出设置

```json
{
  "output_dir": "./results",       // 输出目录
  "write_predictions": true,       // 是否写入预测结果
  "write_checkpoint": true,        // 是否保存检查点
  "log_tensorboard": false         // 是否使用TensorBoard日志
}
```

## 常见配置示例

### 1. 二分类任务（推荐配置）

```json
{
  "dataset": "user_data",
  "classification_threshold": 0.5,
  "epochs": 300,
  "batch_size": 32,
  "learning_rate": 0.001,
  "model": {
    "name": "alignn",
    "classification": true,
    "num_classes": 2,
    "output_features": 2,
    "hidden_features": 256,
    "alignn_layers": 4,
    "gcn_layers": 4
  }
}
```

### 2. 多分类任务（3类或更多）

```json
{
  "dataset": "user_data",
  "classification_threshold": null,  // 多分类不使用阈值
  "model": {
    "name": "alignn",
    "classification": true,
    "num_classes": 5,              // 5个类别
    "output_features": 5           // 输出5个特征
  }
}
```

注意：多分类需要 id_prop.csv 中的 target 列直接包含类别标签 (0, 1, 2, 3, 4)

### 3. 回归任务

```json
{
  "dataset": "user_data",
  "classification_threshold": null,  // 回归任务不使用
  "model": {
    "name": "alignn",
    "classification": false,       // 关闭分类模式
    "output_features": 1           // 单一输出值
  }
}
```

### 4. 小数据集配置（< 1000样本）

```json
{
  "epochs": 500,                   // 增加训练轮数
  "batch_size": 16,                // 减小批次大小
  "learning_rate": 0.0005,         // 降低学习率
  "model": {
    "hidden_features": 128,        // 减小模型容量防止过拟合
    "alignn_layers": 3,
    "gcn_layers": 3
  }
}
```

### 5. 大数据集配置（> 100,000样本）

```json
{
  "epochs": 100,                   // 可以减少轮数
  "batch_size": 128,               // 增加批次大小
  "learning_rate": 0.01,           // 可以提高学习率
  "num_workers": 8,                // 增加数据加载线程
  "model": {
    "hidden_features": 512,        // 增加模型容量
    "alignn_layers": 6,
    "gcn_layers": 6
  }
}
```

## 调优建议

### 学习率调优
- 小数据集: 0.0001 - 0.001
- 中等数据集: 0.001 - 0.01
- 大数据集: 0.01 - 0.1

### 批次大小选择
- GPU内存 6GB: batch_size = 16-32
- GPU内存 12GB: batch_size = 32-64
- GPU内存 24GB: batch_size = 64-128

### 模型容量
- 简单任务/小数据集: hidden_features = 128, layers = 3
- 中等任务: hidden_features = 256, layers = 4
- 复杂任务/大数据集: hidden_features = 512, layers = 6

### 防止过拟合
1. 减小 `hidden_features`
2. 减少层数 (`alignn_layers`, `gcn_layers`)
3. 增加 `weight_decay` (如 1e-5)
4. 增加训练数据
5. 使用数据增强

### 加速训练
1. 增加 `batch_size`
2. 增加 `num_workers`
3. 启用 `use_lmdb`
4. 使用 `scheduler: "onecycle"`
5. 减少 `hidden_features` 和层数

## 错误排查

### ValidationError: Extra inputs are not permitted
**原因**: 使用了模型不支持的参数
**解决**: 移除 `num_heads`, `attention_heads` 等不支持的参数

### Out of Memory (OOM)
**原因**: 批次大小太大或模型太大
**解决**:
- 减小 `batch_size`
- 减小 `hidden_features`
- 减少层数

### 训练不收敛
**原因**: 学习率不合适或模型容量不足
**解决**:
- 调整 `learning_rate` (尝试 0.0001, 0.001, 0.01)
- 使用 `scheduler: "onecycle"`
- 增加模型容量

### 数据加载慢
**原因**: 数据加载瓶颈
**解决**:
- 增加 `num_workers`
- 启用 `use_lmdb: true`
- 启用 `pin_memory: true`

## 参考链接

- [ALIGNN 论文](https://www.nature.com/articles/s41524-021-00650-1)
- [GitHub 仓库](https://github.com/usnistgov/alignn)
- [JARVIS 数据库](https://jarvis.nist.gov/)
