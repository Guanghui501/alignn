# ALIGNN 二分类训练指南

## 数据准备要求

您需要确保数据文件的格式正确：

### 1. 目录结构
```
your_dataset/
├── id_prop.csv
├── structure1.cif
├── structure2.cif
├── structure3.cif
└── ...
```

### 2. id_prop.csv 格式
CSV文件应该包含两列：
- 第一列：CIF文件名（不含扩展名）
- 第二列：标签值（数值）

示例：
```csv
id,target
structure1,0.5
structure2,1.2
structure3,0.003
structure4,0.8
```

对于二分类，标签值会根据您设置的阈值自动转换为0/1类别。

## 下一步操作

### 步骤1：创建配置文件

创建一个配置文件 `config_classification.json`，包含训练参数：

```json
{
  "version": "NA",
  "dataset": "user_data",
  "target": "target",
  "atom_features": "cgcnn",
  "neighbor_strategy": "k-nearest",
  "id_tag": "id",
  "random_seed": 123,
  "classification_threshold": 0.5,
  "epochs": 300,
  "batch_size": 32,
  "learning_rate": 0.001,
  "train_ratio": 0.8,
  "val_ratio": 0.1,
  "test_ratio": 0.1,
  "num_workers": 4,
  "cutoff": 8.0,
  "max_neighbors": 12,
  "output_dir": "./results",
  "model": {
    "name": "alignn",
    "alignn_layers": 4,
    "gcn_layers": 4,
    "atom_input_features": 92,
    "edge_input_features": 80,
    "triplet_input_features": 40,
    "embedding_features": 64,
    "hidden_features": 256,
    "output_features": 2,
    "link": "identity",
    "zero_inflated": false,
    "classification": true
  }
}
```

**重要参数说明：**
- `classification_threshold`: 分类阈值，大于该值为1类，小于等于为0类
- `batch_size`: 批次大小，根据您的GPU内存调整（32或64较常见）
- `epochs`: 训练轮数，通常300-500
- `learning_rate`: 学习率
- `train_ratio/val_ratio/test_ratio`: 训练/验证/测试集划分比例
- `output_dir`: 结果输出目录
- `model.output_features`: 对于二分类，设置为2

### 步骤2：运行训练

使用以下命令开始训练：

```bash
# 基本命令
train_alignn.py --root_dir /path/to/your_dataset \
                --config config_classification.json \
                --classification_threshold 0.5 \
                --output_dir ./results

# 或者更完整的命令
train_alignn.py --root_dir /path/to/your_dataset \
                --config config_classification.json \
                --classification_threshold 0.5 \
                --file_format cif \
                --batch_size 32 \
                --epochs 300 \
                --output_dir ./results_binary_classification
```

**参数说明：**
- `--root_dir`: 包含CIF文件和id_prop.csv的目录路径
- `--config`: 配置文件路径
- `--classification_threshold`: 二分类阈值
- `--file_format`: 结构文件格式（cif/poscar/xyz/pdb）
- `--batch_size`: 批次大小
- `--epochs`: 训练轮数
- `--output_dir`: 输出目录

### 步骤3：检查训练结果

训练完成后，在输出目录中会生成以下文件：

```
results/
├── config.json                          # 训练配置
├── best_model.pt                        # 最佳模型
├── current_model.pt                     # 当前模型
├── last_model.pt                        # 最后一轮模型
├── history_train.json                   # 训练历史
├── history_val.json                     # 验证历史
├── Train_results.json                   # 训练集结果
├── Val_results.json                     # 验证集结果
├── Test_results.json                    # 测试集结果
└── prediction_results_test_set.csv      # 测试集预测结果
```

### 步骤4：评估模型

查看 `prediction_results_test_set.csv` 文件，包含每个样本的预测结果：

```csv
id,target,prediction
structure1,0,0
structure2,1,1
structure3,0,1
...
```

训练日志会显示 ROC AUC 分数，用于评估分类性能。

## 常见问题

### Q1: 如何调整分类阈值？
修改 `--classification_threshold` 参数或配置文件中的 `classification_threshold` 值。

### Q2: GPU 内存不足怎么办？
- 减小 `batch_size`（例如从64改为32或16）
- 减小模型参数（在配置文件中减小 `hidden_features`）

### Q3: 如何使用预训练模型？
```bash
train_alignn.py --root_dir /path/to/your_dataset \
                --config config_classification.json \
                --classification_threshold 0.5 \
                --restart_model_path /path/to/pretrained_model.pt \
                --output_dir ./results
```

### Q4: 数据集太小怎么办？
- 增加 `train_ratio`，减少测试集比例
- 使用数据增强
- 考虑使用预训练模型进行迁移学习

## 下一步优化

训练完成后，可以：
1. 调整超参数（学习率、批次大小、模型层数等）
2. 尝试不同的分类阈值
3. 分析错误预测的样本
4. 使用交叉验证评估模型稳定性

## 示例：完整训练流程

```bash
# 1. 确认数据格式正确
head your_dataset/id_prop.csv

# 2. 运行训练
train_alignn.py --root_dir ./your_dataset \
                --config config_classification.json \
                --classification_threshold 0.5 \
                --file_format cif \
                --batch_size 32 \
                --epochs 300 \
                --output_dir ./classification_results

# 3. 训练完成后查看结果
cat classification_results/prediction_results_test_set.csv
```
