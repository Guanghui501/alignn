# ALIGNN 问题修复指南

## 问题1: pydantic依赖错误

### 错误信息
```
ModuleNotFoundError: No module named 'pydantic._internal'
```

### 原因
pydantic 和 pydantic-settings 版本不兼容。

### 解决方法

**方法1: 使用修复脚本（推荐）**
```bash
chmod +x fix_dependencies.sh
./fix_dependencies.sh
```

**方法2: 手动修复**
```bash
# 卸载旧版本
pip uninstall -y pydantic pydantic-settings

# 安装兼容版本
pip install "pydantic>=2.0.0" "pydantic-settings>=2.0.0"

# 验证安装
python -c "from pydantic_settings import BaseSettings; print('成功')"
python -c "from alignn.config import TrainingConfig; print('成功')"
```

**方法3: 如果上述方法不行，尝试降级**
```bash
pip uninstall -y pydantic pydantic-settings
pip install "pydantic==2.5.0" "pydantic-settings==2.1.0"
```

## 问题2: 数据格式错误

### 问题2.1: id_prop.csv 格式不正确

#### 错误格式示例
```csv
0.cif,1
1.cif,1
2.cif,1
```

#### 正确格式
```csv
id,target
0,1
1,1
2,0
```

**关键点:**
1. 必须有header行（第一行）包含列名 `id,target`
2. id列不应该包含 `.cif` 后缀
3. 只使用文件名（不含扩展名）

### 问题2.2: CIF文件数量为0

#### 原因
- CIF文件不在正确的目录
- CIF文件在子目录中
- 文件名不匹配

#### 解决方法

**使用自动检查和修复工具（推荐）:**
```bash
chmod +x check_and_fix_data.py
python check_and_fix_data.py ./data
```

这个工具会：
- ✅ 自动检查和修复 id_prop.csv 格式
- ✅ 搜索CIF文件的位置
- ✅ 验证文件名匹配
- ✅ 提供数据统计和分类阈值建议
- ✅ 可选择自动移动CIF文件到正确位置

**手动修复:**

1. **检查目录结构**
```bash
cd ./data
ls -la *.cif  # 查看CIF文件
head id_prop.csv  # 查看CSV内容
```

2. **如果CIF文件在子目录中**
```bash
# 查找所有CIF文件
find . -name "*.cif"

# 移动到数据目录
find . -name "*.cif" -exec mv {} . \;
```

3. **修复 id_prop.csv**

创建一个Python脚本 `fix_csv.py`:
```python
import pandas as pd

# 读取（无header）
df = pd.read_csv('id_prop.csv', header=None)

# 设置列名
df.columns = ['id', 'target']

# 去掉.cif后缀
df['id'] = df['id'].str.replace('.cif', '')

# 保存
df.to_csv('id_prop.csv', index=False)

print("修复完成！")
print(df.head())
```

运行:
```bash
python fix_csv.py
```

## 问题3: 文件名不匹配

### 检查方法
```bash
# 检查CSV中的ID
cut -d',' -f1 id_prop.csv | tail -n +2 | head -5

# 检查实际的CIF文件名
ls *.cif | head -5 | sed 's/.cif//'
```

### 确保匹配
id_prop.csv 中的 id 必须与 CIF 文件名（不含扩展名）完全一致。

例如:
- CSV中有 `123,0.5`
- 必须有文件 `123.cif`

## 完整修复流程

```bash
# 1. 修复依赖
./fix_dependencies.sh

# 2. 检查和修复数据
python check_and_fix_data.py ./data

# 3. 如果一切正常，开始训练
./run_binary_classification.sh
```

## 常见错误排查

### 错误: "FileNotFoundError: [Errno 2] No such file or directory"
**原因:** 找不到CIF文件
**解决:** 运行 `python check_and_fix_data.py ./data` 检查文件位置

### 错误: "ValueError: could not convert string to float"
**原因:** target列包含非数值
**解决:** 检查 id_prop.csv 中的target列，确保都是数字

### 错误: "ImportError: cannot import name 'BaseSettings'"
**原因:** pydantic版本问题
**解决:** 运行 `./fix_dependencies.sh`

### 错误: CIF文件解析失败
**原因:** CIF文件格式错误
**解决:** 使用在线工具验证CIF文件格式，如 [CIF validator](https://www.iucr.org/resources/cif/validators)

## 验证一切正常

运行以下命令确认环境正确:

```bash
# 测试依赖
python -c "from alignn.config import TrainingConfig; print('✓ ALIGNN导入成功')"

# 测试数据
python check_and_fix_data.py ./data

# 查看配置
cat config_binary_classification.json | python -m json.tool
```

## 需要帮助?

如果问题仍未解决:
1. 查看完整错误日志
2. 检查Python版本 (推荐 3.8-3.11)
3. 检查依赖版本: `pip list | grep -E "torch|dgl|pydantic"`
4. 提供数据样本（前几行）供诊断

## 快速诊断命令

```bash
# 一键诊断
cat << 'EOF' > diagnose.sh
#!/bin/bash
echo "=== 环境信息 ==="
python --version
echo ""
echo "=== 关键依赖 ==="
pip list | grep -E "torch|dgl|pydantic|alignn"
echo ""
echo "=== 数据检查 ==="
echo "id_prop.csv 前5行:"
head -5 ./data/id_prop.csv
echo ""
echo "CIF文件数量:"
ls ./data/*.cif 2>/dev/null | wc -l
echo ""
echo "=== ALIGNN导入测试 ==="
python -c "from alignn.config import TrainingConfig; print('成功')" 2>&1
EOF

chmod +x diagnose.sh
./diagnose.sh
```

保存诊断输出，便于排查问题。
